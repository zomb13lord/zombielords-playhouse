<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roulette Tracker V68 - Updated</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #00ff88;
            --red: #ff4444; --black: #000; --green: #2e7d32;
            --wait: #ffcc00; --text: #e0e0e0;
            --emerald-glass: rgba(16, 185, 129, 0.1);
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        .lobby-nav {
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(16, 185, 129, 0.3);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        .lobby-nav .brand {
            font-family: 'Cinzel', serif;
            color: var(--accent);
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 900;
        }
        .lobby-nav a {
            font-family: 'Cinzel', serif;
            color: #fff;
            text-decoration: none;
            font-size: 0.7em;
            font-weight: 700;
            border: 1px solid var(--accent);
            padding: 5px 12px;
            border-radius: 2px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        #config-page { padding: 20px; max-width: 500px; margin: 0 auto; }
        .config-grid { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #444; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; }
        label { font-size: 0.6em; color: #888; font-weight: bold; display: block; margin-bottom: 2px; text-transform: uppercase; }
        select, input { width: 100%; padding: 8px; background: #000; border: 1px solid #555; color: #fff; border-radius: 6px; font-size: 0.9em; }
        .btn-start { width: 100%; padding: 18px; background: var(--green); color: #fff; border: none; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        
        #tracker-page { display: none; }
        .frozen-top { position: sticky; top: 0; background: var(--bg); z-index: 100; padding: 10px; border-bottom: 3px solid #444; }
        .status-box { padding: 10px; border-radius: 8px; text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: center; font-weight: bold; border: 2px solid #444; }
        .status-wait { background: #222; color: var(--wait); }
        .status-ready { background: #000; color: #fff; border-color: var(--accent); }
        
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
        .stat-card { background: #000; padding: 8px 2px; border-radius: 6px; text-align: center; border: 1px solid #333; }
        .val { font-weight: bold; color: var(--accent); font-size: 0.95em; }

        .num-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 400px; margin: 0 auto; margin-top: 15px;}
        .num-btn { padding: 18px 0; border: 1px solid #444; border-radius: 6px; color: #fff !important; font-weight: bold; font-size: 1.4em; cursor: pointer; text-align: center; }
        .btn-green { background: var(--green) !important; }
        .btn-red { background: var(--red) !important; }
        .btn-black { background: var(--black) !important; }
        
        .audit-table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 20px; background: var(--card); border-radius: 8px; }
        .audit-table td { padding: 10px 5px; border-bottom: 1px solid #333; text-align: center; }
        .heat-bg { background: #000; width: 85%; height: 6px; border-radius: 4px; margin: 4px auto; border: 1px solid #444; overflow: hidden; }
        .heat-fill { height: 100%; transition: width 0.4s; }
        
        .glow-red { box-shadow: 0 0 15px #f00; border: 2px solid #fff !important; }
        .glow-green { box-shadow: 0 0 15px var(--accent); border: 2px solid #fff !important; }
    </style>
</head>
<body>

<nav class="lobby-nav">
    <div class="brand">Zombie Lord's</div>
    <a href="lobby.html">Return to Playhouse</a>
</nav>

<div id="config-page">
    <div class="config-grid">
        <h2 class="full" style="margin:0; color:var(--accent);">Logic Engine V68</h2>
        <div class="full"><label>Wheel Type</label><select id="wheel-type"><option value="EU" selected>European</option><option value="US">American</option></select></div>
        <div class="full"><label>Terminal Mode</label><select id="view-mode"><option value="AVOID" selected>AVOID</option><option value="PLACE">PLACE</option></select></div>
        <div><label>Unit ($)</label><input type="number" id="unit-cash" value="1"></div>
        <div><label>Warmup</label><input type="number" id="warm-in" value="18"></div>
        <div><label>CD Wait</label><input type="number" id="cool-in" value="10"></div>
        <div><label>Stabilization</label><input type="number" id="stab-in" value="2"></div>
        <input type="hidden" id="mult-in" value="3">
        <input type="hidden" id="cd-trigger" value="2">
        <input type="hidden" id="basket-toggle" checked>
        <input type="hidden" id="perm-hedge" checked>
        <input type="hidden" id="push-toggle" checked>
    </div>
    <button class="btn-start" id="final-start">START SESSION</button>
</div>

<div id="tracker-page">
    <div class="frozen-top">
        <div id="status-box" class="status-box status-wait"><div id="status-txt">WARMING UP</div><div id="sig-box"></div></div>
        <div class="stat-grid">
            <div class="stat-card"><small>PROFIT</small><span id="stat-p" class="val">$0</span></div>
            <div class="stat-card"><small>HIGH</small><span id="stat-h" class="val">$0</span></div>
            <div class="stat-card"><small>BET</small><span id="stat-b" class="val">$0</span></div>
            <div class="stat-card"><small>ROLLS</small><span id="stat-rolls" class="val">0</span></div>
        </div>
    </div>
    <div style="padding:15px;">
        <div id="pad" class="num-pad"></div>
        <table class="audit-table">
            <thead><tr style="color:#666; font-size:0.7em;"><th>STREET</th><th>RANK</th><th>D</th><th>F</th><th>SCORE</th></tr></thead>
            <tbody id="audit-body"></tbody>
        </table>
    </div>
</div>

<script>
(function() {
    const reds = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
    let state = { history: [], stack: [], pockets: [], zeros: [], profit: 0, high: 0, unit: 1, stabCount: 0, lastBottomIds: "", cooldownLeft: 0, lossLevel: 0 };
    let conf = {};

    document.getElementById('final-start').onclick = function() {
        conf = {
            wheel: document.getElementById('wheel-type').value, unitVal: parseFloat(document.getElementById('unit-cash').value) || 1,
            view: document.getElementById('view-mode').value, mult: 3, cdTrigger: 2, 
            cool: parseInt(document.getElementById('cool-in').value), stabLimit: parseInt(document.getElementById('stab-in').value), 
            warm: parseInt(document.getElementById('warm-in').value), basketOn: true
        };
        state.zeros = conf.wheel === 'EU' ? [0] : [0, 37];
        state.pockets = [];
        for(let i=0; i<12; i++) {
            let startNum = (i*3)+1;
            let nums = [startNum, startNum+1, startNum+2];
            if (i === 0) nums = [...nums, ...state.zeros];
            state.pockets.push({id: i, label: (i===0?'BASKET':'ST '+startNum), nums: nums, hs:0, hits:0, d:0, rf:0});
        }
        document.getElementById('config-page').style.display='none'; document.getElementById('tracker-page').style.display='block';
        buildFeltPad(conf.wheel); refresh();
    };

    function buildFeltPad(w) {
        const pad = document.getElementById('pad'); pad.innerHTML = '';
        const zCon = document.createElement('div'); zCon.style.gridColumn = "span 3"; zCon.style.marginBottom = "8px";
        const makeBtn = (v, t) => {
            const b = document.createElement('button'); b.id='nb-'+v; b.className='num-btn btn-green'; b.innerText=t; b.onclick = () => addRoll(v); return b;
        };
        if (w === 'EU') zCon.appendChild(makeBtn(0, '0'));
        else { 
            const row = document.createElement('div'); row.style.display="grid"; row.style.gridTemplateColumns="1fr 1fr"; row.style.gap="8px";
            row.appendChild(makeBtn(0, '0')); row.appendChild(makeBtn(37, '00')); zCon.appendChild(row);
        }
        pad.appendChild(zCon);
        for(let i=1;i<=36;i++) {
            const b = document.createElement('button'); b.id='nb-'+i; b.className='num-btn '+(reds.includes(i)?'btn-red':'btn-black');
            b.innerText=i; b.onclick = () => addRoll(i); pad.appendChild(b);
        }
    }

    function addRoll(n) {
        state.history.push(n);
        if (state.cooldownLeft > 0) state.cooldownLeft--;
        engine(); refresh();
    }

    function engine() {
        const wheelSize = conf.wheel === 'EU' ? 37 : 38;
        // Window Size = Minimum(rollCount, (12 x mult) +1)
        const windowSize = Math.min(state.history.length, (12 * conf.mult) + 1);

        state.pockets.forEach(p => {
            const prob = p.nums.length / wheelSize;
            let d = 0; for(let i=state.history.length-1; i>=0; i--) { if(p.nums.includes(state.history[i])) break; d++; }
            p.d = d; p.nd = ((1/prob)-d)/((1/prob)+d);
            
            let aw=0, hWindow = 0;
            for(let i=state.history.length-1; i>=Math.max(0, state.history.length-windowSize); i--) {
                if(p.nums.includes(state.history[i])) { hWindow++; aw += (1 - (0.85 * ((state.history.length-1-i)/windowSize))); }
            }
            p.hits = hWindow; 
            const exp = windowSize * prob;
            const rf_raw = exp === 0 ? 0 : (aw - exp) / exp; 
            p.rf = rf_raw / (1 + Math.abs(rf_raw)); 
            
            // hs = (rf * 0.55) + (nd * 0.45)
            p.hs = (p.rf * 0.55) + (p.nd * 0.45);
        });
    }

    function refresh() {
        const auditSorted = [...state.pockets].sort((a,b) => b.hs - a.hs);
        const bottomThree = auditSorted.slice(-3);
        const bottomIds = bottomThree.map(p => p.id).sort().join('|');
        const bottomRfCold = bottomThree.every(p => p.rf < 0);

        if (bottomIds !== state.lastBottomIds) {
            state.stabCount = 0;
            state.lastBottomIds = bottomIds;
        } else if (state.history.length >= conf.warm) {
            state.stabCount++;
        }

        const isReady = state.history.length >= conf.warm && state.cooldownLeft === 0 && state.stabCount >= conf.stabLimit && bottomRfCold;
        
        let status = (state.history.length < conf.warm) ? "WARMING UP" : 
                     (state.cooldownLeft > 0) ? "COOLDOWN" : 
                     (!bottomRfCold || state.stabCount < conf.stabLimit) ? "STABILIZING" : "READY";
        
        document.getElementById('status-txt').innerText = status;
        document.getElementById('status-box').className = "status-box " + (isReady ? "status-ready" : "status-wait");
        
        document.getElementById('stat-rolls').innerText = state.history.length;
        const bdy = document.getElementById('audit-body'); bdy.innerHTML = '';
        auditSorted.forEach((p, idx) => {
            const tr = document.createElement('tr');
            const w = Math.min(Math.max(((p.hs+1)/2)*100, 5), 100);
            tr.innerHTML = `<td><b>${p.label}</b><div class="heat-bg"><div class="heat-fill" style="width:${w}%; background:${p.hs>0?'var(--accent)':'var(--red)'}"></div></div></td><td>${idx+1}</td><td>${p.d}</td><td>${p.hits}</td><td>${p.hs.toFixed(2)}</td>`;
            bdy.appendChild(tr);
        });
    }
})();
</script>
</body>
</html>
