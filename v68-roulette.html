<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roulette Tracker V68</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --accent: #00ff88;
            --red: #ff4444; --black: #000; --green: #2e7d32;
            --wait: #ffcc00; --text: #e0e0e0;
            --emerald-glass: rgba(16, 185, 129, 0.1);
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        
        /* Lobby Navigation Bar */
        .lobby-nav {
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(16, 185, 129, 0.3);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        .lobby-nav .brand {
            font-family: 'Cinzel', serif;
            color: var(--accent);
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 900;
        }
        .lobby-nav a {
            font-family: 'Cinzel', serif;
            color: #fff;
            text-decoration: none;
            font-size: 0.7em;
            font-weight: 700;
            border: 1px solid var(--accent);
            padding: 5px 12px;
            border-radius: 2px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }
        .lobby-nav a:hover {
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.4);
        }

        #config-page { padding: 20px; max-width: 500px; margin: 0 auto; }
        .config-grid { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #444; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; }
        label { font-size: 0.6em; color: #888; font-weight: bold; display: block; margin-bottom: 2px; text-transform: uppercase; }
        select, input { width: 100%; padding: 8px; background: #000; border: 1px solid #555; color: #fff; border-radius: 6px; font-size: 0.9em; }
        .btn-start { width: 100%; padding: 18px; background: var(--green); color: #fff; border: none; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .compact-toggles { display: flex; flex-direction: column; gap: 8px; grid-column: span 2; }
        .toggle-box { flex: 1; display: flex; align-items: center; justify-content: space-between; background: #111; padding: 8px; border-radius: 6px; border: 1px solid #333; font-size: 0.7em; font-weight: bold; }

        #tracker-page { display: none; }
        .frozen-top { position: sticky; top: 0; background: var(--bg); z-index: 100; padding: 10px; border-bottom: 3px solid #444; }
        .status-box { padding: 10px; border-radius: 8px; text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: center; font-weight: bold; border: 2px solid #444; }
        .status-wait { background: #222; color: var(--wait); }
        .status-ready { background: #000; color: #fff; border-color: var(--accent); }
        
        .cmd-card { display: flex; flex-direction: column; border-radius: 6px; border: 2px solid #fff; overflow: hidden; margin-top: 10px; }
        .cmd-head { font-size: 0.7em; padding: 4px; text-transform: uppercase; font-weight: 900; }
        .cmd-body { font-size: 1.1em; padding: 8px; font-weight: 900; background: rgba(0,0,0,0.6); }
        .mode-avoid { background: #800; }
        .mode-place { background: #052; }

        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin: 10px 0; }
        .stat-card { background: #000; padding: 8px 2px; border-radius: 6px; text-align: center; border: 1px solid #333; }
        .val { font-weight: bold; color: var(--accent); font-size: 0.95em; }

        .history-feed { display: flex; gap: 8px; justify-content: center; margin-top: 8px; min-height: 38px; overflow: hidden; }
        .chip { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85em; border: 2px solid rgba(255,255,255,0.2); color: #fff; flex-shrink: 0; }

        .num-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 400px; margin: 0 auto; margin-top: 15px;}
        .zero-container { grid-column: span 3; display: flex; flex-direction: column; gap: 8px; margin-bottom: 8px; }
        .num-btn { padding: 18px 0; border: 1px solid #444; border-radius: 6px; color: #fff !important; font-weight: bold; font-size: 1.4em; cursor: pointer; text-align: center; }
        .btn-green { background: var(--green) !important; }
        .btn-red { background: var(--red) !important; }
        .btn-black { background: var(--black) !important; }
        
        .audit-table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 20px; background: var(--card); border-radius: 8px; }
        .audit-table td { padding: 10px 5px; border-bottom: 1px solid #333; text-align: center; }
        .heat-bg { background: #000; width: 85%; height: 6px; border-radius: 4px; margin: 4px auto; border: 1px solid #444; overflow: hidden; }
        .heat-fill { height: 100%; transition: width 0.4s; }
        
        @keyframes pulse-r { 0%, 100% { box-shadow: 0 0 5px #f00; } 50% { box-shadow: 0 0 25px #f00; border-color: #fff; } }
        @keyframes pulse-g { 0%, 100% { box-shadow: 0 0 5px var(--accent); } 50% { box-shadow: 0 0 25px var(--accent); border-color: #fff; } }
        .glow-red { animation: pulse-r 0.8s infinite; border: 3px solid #fff !important; z-index: 10; }
        .glow-green { animation: pulse-g 0.8s infinite; border: 3px solid #fff !important; z-index: 10; }
    </style>
</head>
<body>

<nav class="lobby-nav">
    <div class="brand">Zombie Lord's</div>
    <a href="lobby.html">Return to Playhouse</a>
</nav>

<div id="config-page">
    <div class="config-grid">
        <h2 class="full" style="margin:0; color:var(--accent);">Logic Engine V68</h2>
        <div class="full"><label>Wheel Type</label><select id="wheel-type"><option value="EU">European</option><option value="US" selected>American</option><option value="TZ">Triple Zero</option></select></div>
        <div class="full"><label>Domain</label><select id="dom-sel"><option value="9ST" selected>9 Streets</option></select></div>
        <div class="full"><label>Strategy</label><select id="strat-sel"><option value="COLD" selected>Cold Hunt</option></select></div>
        <div><label>Progression</label><select id="prog-sel"><option value="MART" selected>Martingale</option></select></div>
        <div><label>Terminal Mode</label><select id="view-mode"><option value="AVOID">AVOID</option><option value="PLACE" selected>PLACE</option></select></div>
        <div class="compact-toggles">
            <div style="display:flex; gap:8px;">
                <div class="toggle-box">HEDGE <input type="checkbox" id="basket-toggle" checked></div>
                <div class="toggle-box">PERM HEDGE <input type="checkbox" id="perm-hedge" checked></div>
            </div>
            <div class="toggle-box" style="margin-top:8px;">PUSH (1:1 Ratio) <input type="checkbox" id="push-toggle" checked></div>
        </div>
        <div><label>Unit ($)</label><input type="number" id="unit-cash" value="1"></div>
        <div><label>Warmup</label><input type="number" id="warm-in" value="18"></div>
        <div class="full"><label>Lookback Window</label><select id="mult-in"><option value="1">Short</option><option value="2">Standard</option><option value="3" selected>Long</option></select></div>
        <div><label>CD Loss Streak</label><input type="number" id="cd-trigger" value="2"></div>
        <div><label>CD Wait</label><input type="number" id="cool-in" value="3"></div>
        <div class="full"><label>Stabilization</label><input type="number" id="stab-in" value="1"></div>
    </div>
    <button class="btn-start" id="final-start">START SESSION</button>
</div>

<div id="tracker-page">
    <div class="frozen-top">
        <div id="status-box" class="status-box status-wait"><div id="status-txt">WARMING UP</div><div id="sig-box"></div></div>
        <div class="stat-grid">
            <div class="stat-card"><small>PROFIT</small><span id="stat-p" class="val">$0</span></div>
            <div class="stat-card"><small>HIGH</small><span id="stat-h" class="val">$0</span></div>
            <div class="stat-card"><small>BET</small><span id="stat-b" class="val">$0</span></div>
            <div class="stat-card"><small>ROLLS</small><span id="stat-rolls" class="val">0</span></div>
        </div>
        <div id="feed" class="history-feed"></div>
    </div>
    <div style="padding:15px;">
        <div id="pad" class="num-pad"></div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
            <button id="final-undo" style="background:#444; color:#fff; padding:15px; border:none; border-radius:6px; font-weight:bold;">UNDO</button>
            <button onclick="window.location.reload()" style="background:#800; color:#fff; padding:15px; border:none; border-radius:6px; font-weight:bold;">RESET</button>
        </div>
        <table class="audit-table">
            <thead><tr style="color:#666; font-size:0.7em;"><th>STREET / BASKET</th><th>RANK</th><th>D</th><th>F</th><th>SCORE</th></tr></thead>
            <tbody id="audit-body"></tbody>
        </table>
    </div>
</div>

<script>
(function() {
    const reds = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
    let state = { history: [], stack: [], pockets: [], zeros: [], profit: 0, high: 0, unit: 1, stabCount: 0, lastSigIds: "", cooldownLeft: 0, lossLevel: 0, lastHitCounts: {} };
    let conf = {};

    document.getElementById('final-start').onclick = function() {
        conf = {
            wheel: document.getElementById('wheel-type').value, unitVal: parseFloat(document.getElementById('unit-cash').value) || 1,
            basketOn: document.getElementById('basket-toggle').checked, pushOn: document.getElementById('push-toggle').checked,
            permHedge: document.getElementById('perm-hedge').checked, view: document.getElementById('view-mode').value,
            mult: parseInt(document.getElementById('mult-in').value), cdTrigger: parseInt(document.getElementById('cd-trigger').value), 
            cool: parseInt(document.getElementById('cool-in').value), stabLimit: parseInt(document.getElementById('stab-in').value), 
            warm: parseInt(document.getElementById('warm-in').value)
        };
        state.zeros = conf.wheel === 'EU' ? [0] : (conf.wheel === 'US' ? [0, 37] : [0, 37, 38]);
        state.pockets = [];
        for(let i=0; i<12; i++) {
            let startNum = (i*3)+1;
            let label = (i === 0 && conf.basketOn) ? 'BASKET' : 'ST '+startNum;
            let nums = [startNum, startNum+1, startNum+2];
            if (i === 0 && conf.basketOn) nums = [...nums, ...state.zeros];
            state.pockets.push({id: i, label: label, nums: nums, hs:0, hits:0, d:0, rf:0, isBasket: (i===0 && conf.basketOn), dozen: Math.floor(i/4)+1});
            state.lastHitCounts[i] = 0;
        }
        document.getElementById('config-page').style.display='none'; document.getElementById('tracker-page').style.display='block';
        buildFeltPad(conf.wheel); refresh();
    };

    function buildFeltPad(w) {
        const pad = document.getElementById('pad'); pad.innerHTML = '';
        const container = document.createElement('div'); container.className = 'zero-container';
        const makeBtn = (val, txt) => {
            const b = document.createElement('button'); b.id='nb-'+val; b.className='num-btn btn-green'; b.innerText=txt; b.onclick = () => addRoll(val); return b;
        };
        if (w === 'EU') { container.appendChild(makeBtn(0, '0')); } 
        else if (w === 'US') { 
            const row = document.createElement('div'); row.style.display="grid"; row.style.gridTemplateColumns="1fr 1fr"; row.style.gap="8px";
            row.appendChild(makeBtn(0, '0')); row.appendChild(makeBtn(37, '00')); container.appendChild(row);
        } else {
            const row1 = document.createElement('div'); row1.appendChild(makeBtn(38, '000')); container.appendChild(row1);
            const row2 = document.createElement('div'); row2.style.display="grid"; row2.style.gridTemplateColumns="1fr 1fr"; row2.style.gap="8px"; row2.style.marginTop="8px";
            row2.appendChild(makeBtn(0, '0')); row2.appendChild(makeBtn(37, '00')); container.appendChild(row2);
        }
        pad.appendChild(container);
        for(let i=1;i<=36;i++) {
            const b = document.createElement('button'); b.id='nb-'+i; b.className='num-btn '+(reds.includes(i)?'btn-red':'btn-black');
            b.innerText=i; b.onclick = () => addRoll(i); pad.appendChild(b);
        }
    }

    function addRoll(n) {
        state.stack.push(JSON.stringify({history:[...state.history], profit:state.profit, high:state.high, unit:state.unit, cooldownLeft:state.cooldownLeft, stabCount:state.stabCount, lastSigIds:state.lastSigIds, lossLevel:state.lossLevel, lastHitCounts:{...state.lastHitCounts}}));
        if(document.getElementById('status-txt').innerText === "READY") {
            const avoidIds = getBettingAvoids().map(x=>x.id);
            let inBasket = state.pockets[0].nums.includes(n);
            let won = !avoidIds.includes((n === 0 || n > 36) ? 0 : Math.floor((n-1)/3));
            if(won) {
                if (conf.basketOn && inBasket && !avoidIds.includes(0)) {
                    let payout = { 'EU': 8, 'US': 6, 'TZ': 5 }[conf.wheel];
                    state.profit += conf.pushOn ? (state.unit * conf.unitVal * ((payout + 1) - 9)) : (state.unit * conf.unitVal * ((3 * payout + 3) - 19));
                    state.consecutiveWins = 0;
                } else {
                    state.profit += (state.unit * conf.unitVal * ((conf.basketOn && !conf.pushOn) ? 5 : 3));
                    state.consecutiveWins++;
                }
                if (state.profit >= state.high) { state.unit = 1; state.lossLevel = 0; }
                else if (state.consecutiveWins >= 2) state.unit = Math.max(1, Math.floor(state.unit / 2));
            } else {
                if (!(conf.basketOn && inBasket && !avoidIds.includes(0))) {
                    state.profit -= (state.unit * conf.unitVal * ((avoidIds.includes(0) || conf.pushOn || !conf.basketOn) ? 9 : 19));
                    state.lossLevel++; state.consecutiveWins = 0; state.unit *= 2;
                    if (state.lossLevel >= conf.cdTrigger) state.cooldownLeft = conf.cool;
                    state.stabCount = 0;
                } else { state.consecutiveWins = 0; }
            }
            if(state.profit > state.high) state.high = state.profit;
        } else if (state.cooldownLeft > 0) state.cooldownLeft--;
        state.history.push(n); engine(); refresh();
    }

    function engine() {
        const wheelSize = conf.wheel === 'EU' ? 37 : (conf.wheel === 'US' ? 38 : 39);
        state.pockets.forEach(p => {
            const prob = p.nums.length / wheelSize;
            let d = 0; for(let i=state.history.length-1; i>=0; i--) { if(p.nums.includes(state.history[i])) break; d++; }
            p.d = d; p.nd = ((1/prob)-d)/((1/prob)+d);
            let aw=0, hWindow = 0; let windowSize = (12 * conf.mult) + 1;
            for(let i=state.history.length-1; i>=Math.max(0, state.history.length-windowSize); i--) {
                if(p.nums.includes(state.history[i])) { hWindow++; aw += (1 - (0.85 * ((state.history.length-1-i)/windowSize))); }
            }
            p.hits = hWindow; const exp = windowSize * prob;
            const rf_raw = (aw - exp) / exp; p.rf = rf_raw/(1+Math.abs(rf_raw)); 
            p.hs = (p.rf * 0.45) + (p.nd * 0.55);
        });
    }

    function getBettingAvoids() {
        let pool = [...state.pockets].filter(p => !(conf.permHedge && p.isBasket));
        const wheelSize = conf.wheel === 'EU' ? 37 : (conf.wheel === 'US' ? 38 : 39);
        
        // Momentum Disqualification
        pool = pool.filter(p => {
            const rot = Math.floor(wheelSize / p.nums.length);
            const slice = state.history.slice(-rot);
            let h = 0; slice.forEach(r => { if(p.nums.includes(r)) h++; });
            return h < 2; 
        });

        // THE TRIPLE-TIER SORT
        pool.sort((a, b) => {
            // Tier 1: Heat Score (Strict Math)
            if (Math.abs(a.hs - b.hs) > 0.001) return a.hs - b.hs;
            // Tier 2: Dozen Priority (3 > 2 > 1)
            if (a.dozen !== b.dozen) return b.dozen - a.dozen;
            // Tier 3: Street ID (Descending)
            return b.id - a.id;
        });

        let final = pool.slice(0, 3);

        // Conditional Sticky Check (Zero-Hit Anchor Only)
        if (state.lastSigIds) {
            let lastIds = state.lastSigIds.split('|').map(Number);
            lastIds.forEach(oldId => {
                let p = state.pockets.find(x => x.id === oldId);
                if (p && !final.find(f => f.id === p.id) && pool.find(f => f.id === p.id)) {
                    if (p.hits === 0) { final.pop(); final.push(p); final.sort((a,b) => a.hs - b.hs); }
                }
            });
        }
        return final;
    }

    function refresh() {
        const auditSorted = [...state.pockets].sort((a,b) => b.hs - a.hs);
        const avoids = getBettingAvoids();
        const currentSigKey = avoids.map(x=>x.id).sort().join('|');
        if (currentSigKey !== state.lastSigIds) { state.stabCount = 0; state.lastSigIds = currentSigKey; } else { state.stabCount++; }

        let status = (state.history.length < conf.warm) ? "WARMUP ("+state.history.length+"/"+conf.warm+")" : 
                     (state.cooldownLeft > 0) ? "COOLDOWN ("+state.cooldownLeft+")" : 
                     (state.stabCount < conf.stabLimit) ? "STABILIZING ("+state.stabCount+"/"+conf.stabLimit+")" : "READY";
        
        let sCls = (status === "READY") ? "status-ready" : "status-wait";
        document.getElementById('status-txt').innerText = status; document.getElementById('status-box').className = "status-box "+sCls;
        const sigArea = document.getElementById('sig-box'); sigArea.innerHTML = "";
        document.querySelectorAll('.num-btn').forEach(btn => btn.classList.remove('glow-red', 'glow-green'));

        if(status === "READY") {
            const dispSorted = [...avoids].sort((a,b) => a.id - b.id);
            const aIds = avoids.map(x=>x.id);
            const p9 = state.pockets.filter(p => !aIds.includes(p.id) && !(conf.permHedge && p.isBasket)).sort((a,b)=>a.id - b.id);
            
            if(conf.view === 'AVOID') {
                sigArea.innerHTML = `<div class="cmd-card mode-avoid"><div class="cmd-head">AVOID STREETS</div><div class="cmd-body">${dispSorted.map(p=>p.label).join(', ')}</div></div>`;
                avoids.forEach(p => p.nums.forEach(n => { const b = document.getElementById('nb-'+n); if(b) b.classList.add('glow-red'); }));
            } else {
                const stU = (!conf.basketOn || conf.pushOn) ? state.unit : state.unit * 2;
                const bU = conf.pushOn ? state.unit : state.unit * 3;
                let bT = (conf.basketOn && (!aIds.includes(0) || conf.permHedge)) ? ` + B (${bU})` : "";
                sigArea.innerHTML = `<div class="cmd-card mode-place"><div class="cmd-head">PLACE ON</div><div class="cmd-body">${p9.map(p=>p.label).join(', ')}<br><span style="font-size:0.6em; color:var(--accent)">STREETS: ${stU} UNIT(S)${bT}</span></div></div>`;
                p9.forEach(p => p.nums.forEach(n => { const b = document.getElementById('nb-'+n); if(b) b.classList.add('glow-green'); }));
                if(conf.basketOn && (!aIds.includes(0) || conf.permHedge)) { [...state.zeros, 1, 2, 3].forEach(n => { const b = document.getElementById('nb-'+n); if(b) b.classList.add('glow-green'); }); }
            }
        }
        
        document.getElementById('stat-p').innerText = `$${state.profit.toFixed(2)}`; document.getElementById('stat-h').innerText = `$${state.high.toFixed(2)}`;
        document.getElementById('stat-rolls').innerText = state.history.length;
        let betT = 0; if(status === "READY") {
            const aIds = avoids.map(x=>x.id);
            if (!conf.basketOn) betT = state.unit * 9;
            else if(conf.pushOn) betT = 9 * state.unit;
            else betT = (aIds.includes(0) && !conf.permHedge) ? state.unit * 18 : state.unit * 19;
        }
        document.getElementById('stat-b').innerText = `$${(betT * conf.unitVal).toFixed(2)}`;
        const feed = document.getElementById('feed'); feed.innerHTML = ''; state.history.slice(-8).reverse().forEach(n => {
            const chip = document.createElement('div'); chip.className='chip'; chip.style.background = (n === 0 || n > 36) ? '#2e7d32' : (reds.includes(n) ? '#d32f2f' : '#000');
            chip.innerText = n === 37 ? '00' : (n === 38 ? '000' : n); feed.appendChild(chip);
        });
        state.pockets.forEach(p => state.lastHitCounts[p.id] = p.hits);
        const bdy = document.getElementById('audit-body'); bdy.innerHTML = '';
        if (conf.permHedge) { renderRow(state.pockets[0], bdy, true, 'â˜…'); }
        auditSorted.forEach((p, idx) => { if(conf.permHedge && p.isBasket) return; renderRow(p, bdy, false, idx + 1); });
    }
    function renderRow(p, bdy, pin, rank) {
        const tr = document.createElement('tr'); if(pin) tr.className = 'pinned';
        const w = Math.min(Math.max(((p.hs+1)/2.2)*100, 5), 100);
        tr.innerHTML = `<td><b>${p.label}</b><div class="heat-bg"><div class="heat-fill" style="width:${w}%; background:${p.hs>0.05?'var(--accent)':(p.hs<-0.15?'var(--red)':'var(--wait)')}"></div></div></td><td>${rank}</td><td>${p.d}</td><td>${p.hits}</td><td>${p.hs.toFixed(2)}</td>`;
        bdy.appendChild(tr);
    }
    document.getElementById('final-undo').onclick = function() { if(!state.stack.length) return; Object.assign(state, JSON.parse(state.stack.pop())); engine(); refresh(); };
})();
</script>
</body>
</html>
